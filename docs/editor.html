<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="./favicon.ico">
    <link rel="stylesheet" href="css/reset.css" />
    <link rel="stylesheet" href="css/main.css" />
    <title>AV Editor</title>
  </head>

  <body>
    <header>
      <div class="container">
        <h1>Editor</h1>
      </div>
    </header>
    <nav>
      <div class="container">
        <ul>
          <li><a href="./">Home</a></li>
        </ul>
      </div>
    </nav>
    <main>
      <div class="container editor">
        <!-- Main content start -->
        <h2 id="page-title">Video Title</h2>

        <div id="media-wrapper" class="media-wrapper">
          <!-- Media & Global Controls Content -->
        </div>

        <div id="editor-wrapper" class="editor-wrapper">
          <!-- Transcript & Editor Content Start -->

          <!-- <form action="javascript:void(0);" method="" class="cue-form"> -->
          <template id="cue-template">
            <div
              id="cue-wrapper"
              class="cue"
              data-cue="${id}"
              data-start-time="${startTime}"
              data-end-time="${endTime}"
              data-avg-prob="${avgProb}"
              data-min-prob="${minProb}"
            >
              <div id="cue-controls" class="cue-controls">
                <button id="time-button" class="button cue-select-button">${formattedTime}</button>
                <button id="play-pause-button" class="button cue-play-button" aria-label="Play and Pause"></button>
              </div>
              <textarea id="cue-text" name="cue-text" class="cue-text" rows="" cols="">${text}</textarea>
            </div>
          </template>
          <!-- </form> -->
          <!-- Transcript & Editor Content End-->
        </div>
        <!-- Main content end -->
      </div>
    </main>

    <footer></footer>
    <!-- Scripts -->
    <script type="module" defer>
      import { getMediaItem } from "./js/components/api.js";

      const pageTitle = document.querySelector("#page-title");
      const mediaWrapper = document.querySelector("#media-wrapper");
      const editorWrapper = document.querySelector("#editor-wrapper");

      // Get the media data and render video
      async function renderMedia() {
        const mediaItem = await getMediaItem();

        if (!mediaItem) {
          showNoMediaMessage();
          return;
        }

        const { id, title, url, poster, transcript } = mediaItem;
        const video = document.createElement("video");
        video.controls = true;
        video.poster = poster;
        video.src = url;
        video.id = `video-${id}`;

        // video.autoplay = true;
        // video.playbackRate = 2;

        pageTitle.textContent = title;
        document.title = `${title} | ${document.title}`;

        mediaWrapper.textContent = "";

        mediaWrapper.appendChild(video);

        return { transcript, id, video };
      }

      // Returns no media message if media item is not found
      function showNoMediaMessage() {
        document.querySelector("main").innerHTML =
          '<div class="info info--warning">Sorry. The item you\'re looking for isn\'t available. You can <a href="/">browse our library</a> for a different item.</div>';
      }

      // Helper to convert track cue seconds to HH:MM:SS format
      function getFormattedTimeFromSeconds(seconds) {
        const hours = (Math.floor(seconds / 3600) % 24).toString().padStart(2, "0");
        const minutes = Math.floor((seconds % 3600) / 60)
          .toString()
          .padStart(2, "0");
        seconds = Math.round(seconds % 60)
          .toString()
          .padStart(2, "0");
        return `${hours}:${minutes}:${seconds}`;
      }

      // Helper to get avg, min, max from array of nums between 0 and 1
      function getWordProbabilities(words) {
        if (!words) return;

        const probabilities = words.map(word => word.probability);
        const avg =
          Math.round((probabilities.reduce((acc, prob) => acc + prob, 0) / probabilities.length) * 1000) / 1000;
        const min = Math.round(Math.min(...probabilities) * 1000) / 1000;
        const max = Math.round(Math.max(...probabilities) * 1000) / 1000;

        return { avg, min, max };
      }

      // Add track and cues to video from transcript segments
      function addTrack(video, transcript) {
        const track = video.addTextTrack("captions", transcript.label, transcript.language);
        track.mode = "showing";
        // Flag to check if track has been edited, and saved to local storage
        // If edited, probs calculated already and won't have words, etc
        track.edited = false;

        let cues = transcript.segments.map(segment => {
          const { id, start, end, text, words } = segment;

          const cue = new VTTCue(start, end, text.trim());
          cue.id = id;
          cue.formattedTime = getFormattedTimeFromSeconds(start);

          // Only compute probs if word-level time stamps are available
          // Perhaps update session store function to modify on initial store to
          // avoid recalcuation on each refresh. Replace "words" with "probabilities"?
          if (words) {
            const { avg, min, max } = getWordProbabilities(words, track.edited);
            cue.avgProb = avg;
            cue.maxProb = max;
            cue.minProb = min;
          }

          track.addCue(cue);

          return cue;
        });

        return { track, cues };
      }

      function addTranscript({ track, cues, itemId }) {
        const cueTemplate = document.querySelector("#cue-template");
        const transcriptForm = document.createElement("form");
        transcriptForm.id = `transcript-form-${itemId}`;
        transcriptForm.className = "cue-form";

        if (cueTemplate) {
          cues.forEach(cue => {
            const { id, startTime, endTime, avgProb, minProb, formattedTime, text } = cue;

            const clone = cueTemplate.content.cloneNode(true);
            const cueWrapper = clone.getElementById("cue-wrapper");
            const cueControls = clone.getElementById("cue-controls");
            const timeButton = clone.getElementById("time-button");
            const playPauseButton = clone.getElementById("play-pause-button");
            const cueText = clone.getElementById("cue-text");

            cueWrapper.id = `cue-${id}`;
            cueWrapper.dataset.cue = id;
            cueWrapper.dataset.startTime = startTime;
            cueWrapper.dataset.endTime = endTime;
            cueWrapper.dataset.avgProb = avgProb;
            cueWrapper.dataset.minProb = minProb;
            cueText.id = `cue-text-${id}`;
            cueText.name = `${id}`;

            cueText.value = text;
            timeButton.textContent = formattedTime;

            transcriptForm.appendChild(clone);
          });

          editorWrapper.appendChild(transcriptForm);
          return transcriptForm;
        }

        const cuesHTML = cues
          .map(cue => {
            const { id, startTime, endTime, avgProb, minProb, formattedTime, text } = cue;

            return `
              <div 
                  id="cue-${id}" 
                  class="cue" 
                  data-cue="${id}" 
                  data-start-time="${startTime}" 
                  data-end-time="${endTime}"
                  data-avg-prob="${avgProb}" 
                  data-min-prob="${minProb}">
                <div class="cue-controls">
                  <button class="button cue-select-button">${formattedTime}</button>
                  <button class="button cue-play-button" aria-label="Play and Pause"></button>
                </div>
                <textarea id="cue-${id}-text" name="${id}" class="cue-text" rows="2" cols="">${text}</textarea>
              </div>`;
          })
          .join("");

        transcriptForm.innerHTML = cuesHTML;
        editorWrapper.appendChild(transcriptForm);
        return transcriptForm;
      }

      function highlightCueSegment(event, video) {
        if (!event.target.activeCues[0]) return;
        const previousCues = editorWrapper.querySelectorAll(".cue--focus");

        if (previousCues) {
          previousCues.forEach(previousCue => {
            previousCue.classList.remove("cue--focus");
            previousCue.querySelector(".cue-select-button").classList.toggle("cue-select-button--playing");
          });
        }

        const scrollTargetID = `cue-${event.target.activeCues[0].id}`;
        const scrollTarget = editorWrapper.querySelector(`#${scrollTargetID}`);
        const timeButton = scrollTarget.querySelector(".cue-select-button");

        const isPlaying = video.paused;

        scrollTarget.classList.add("cue--focus");
        timeButton.classList.toggle("cue-select-button--playing", isPlaying);

        scrollTarget.scrollIntoView({ behavior: "smooth", block: "center" });
      }

      function setToTime(event, video) {
        console.log;
        if (!event.target.matches(".cue *")) return;

        const cueTime = event.target.closest("[data-cue]").dataset.startTime || null;
        if (!cueTime) return;

        video.currentTime = cueTime;
      }

      function playPauseMedia(event, video, editorWrapper) {
        setToTime(event, video);
        const isPlaying = !video.paused;
        editorWrapper.classList.toggle("is-playing", isPlaying);

        if (!event.target.matches(".cue-play-button, .cue-pause-button")) return;

        isPlaying ? video.pause() : video.play();
      }

      function updatePlayState(event, video, editorWrapper) {
        const isPlaying = !video.paused;
        editorWrapper.classList.toggle("is-playing", isPlaying);
      }

      function addListeners(track, video, editorWrapper) {
        track.addEventListener("cuechange", event => highlightCueSegment(event, video));

        editorWrapper.addEventListener("click", event => playPauseMedia(event, video, editorWrapper));

        video.addEventListener("playing", event => updatePlayState());
        video.addEventListener("pause", event => updatePlayState());
      }

      // Render media then add track from transcript
      renderMedia().then(mediaData => {
        if (!mediaData) return;
        const { transcript, id: itemId, video } = mediaData;

        // Add track and cues to video from transcript segments
        const { track, cues } = addTrack(video, transcript);

        // Generate, render transcript editor code
        const form = addTranscript({ track, cues, itemId });

        // Add event listeners

        track.addEventListener("cuechange", event => highlightCueSegment(event, video));
        editorWrapper.addEventListener("click", event => playPauseMedia(event, video, editorWrapper));
        video.addEventListener("playing", event => updatePlayState(event, video, editorWrapper));
        video.addEventListener("pause", event => updatePlayState(event, video, editorWrapper));
        form.addEventListener("submit", event => event.preventDefault());
        form.addEventListener("change", event => {
          const data = new FormData(form);
          console.log(data);
        });
      });
    </script>
  </body>
</html>
