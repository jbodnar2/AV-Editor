<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="./favicon.ico" />
    <link rel="stylesheet" href="css/reset.css" />
    <link rel="stylesheet" href="css/main.css" />
    <title>AV Editor</title>
  </head>

  <body>
    <header>
      <div class="container">
        <h1>Editor</h1>
      </div>
    </header>
    <nav>
      <div class="container">
        <ul>
          <li><a href="./">Home</a></li>
        </ul>
      </div>
    </nav>
    <main>
      <div class="container editor">
        <!-- Main content start -->

        <h2 id="page-title">Video Title</h2>

        <div id="media-wrapper" class="media-wrapper">
          <!-- Media & Global Controls Content -->
        </div>

        <div id="editor-wrapper" class="editor-wrapper" data-show-end></div>

        <!-- Main content end -->
      </div>
    </main>

    <footer></footer>
    <!-- Scripts -->
    <script type="module" defer>
      import { getMediaItem } from "./js/components/api.js";
      import { addTrack } from "./js/components/tracks.js";
      import { addTranscript } from "./js/components/transcripts.js";

      const pageTitle = document.querySelector("#page-title");
      const mediaWrapper = document.querySelector("#media-wrapper");
      const editorWrapper = document.querySelector("#editor-wrapper");

      function showNoMediaMessage() {
        document.querySelector("main").innerHTML =
          '<div class="info info--warning">Sorry. The item you\'re looking for isn\'t available. You can <a href="/">browse our library</a> for a different item.</div>';
      }

      async function renderMedia() {
        const mediaItem = await getMediaItem();

        if (!mediaItem) {
          showNoMediaMessage();
          return;
        }

        const { id, title, url, poster, transcript } = mediaItem;
        const video = document.createElement("video");
        video.controls = true;
        video.poster = poster;
        video.src = url;
        video.id = `video-${id}`;

        pageTitle.textContent = title;
        document.title = `${title} | ${document.title}`;

        mediaWrapper.textContent = "";

        mediaWrapper.appendChild(video);

        return { transcript, id, video };
      }

      function highlightCueSegment(event, video) {
        if (!event.target.activeCues[0]) return;
        const previousCues = editorWrapper.querySelectorAll(".cue--focus");

        if (previousCues) {
          previousCues.forEach(previousCue => {
            previousCue.classList.remove("cue--focus");
            previousCue.querySelector(".cue-select-button").classList.toggle("cue-select-button--playing");
          });
        }

        const scrollTargetID = `cue-${event.target.activeCues[0].id}`;
        const scrollTarget = editorWrapper.querySelector(`#${scrollTargetID}`);
        const timeButton = scrollTarget.querySelector(".cue-select-button");

        const isPlaying = video.paused;

        scrollTarget.classList.add("cue--focus");
        timeButton.classList.toggle("cue-select-button--playing", isPlaying);

        scrollTarget.scrollIntoView({ behavior: "smooth", block: "center" });
      }

      function setToTime(event, video) {
        console.log;
        if (!event.target.matches(".cue *")) return;

        const cueTime = event.target.closest("[data-cue]").dataset.startTime || null;
        if (!cueTime) return;

        video.currentTime = cueTime;
      }

      function playPauseMedia(event, video, editorWrapper) {
        setToTime(event, video);
        const isPlaying = !video.paused;
        editorWrapper.classList.toggle("is-playing", isPlaying);

        if (!event.target.matches(".cue-play-button, .cue-pause-button")) return;

        isPlaying ? video.pause() : video.play();
      }

      function updatePlayState(event, video, editorWrapper) {
        const isPlaying = !video.paused;
        editorWrapper.classList.toggle("is-playing", isPlaying);
      }

      function addListeners(track, video, editorWrapper) {
        track.addEventListener("cuechange", event => highlightCueSegment(event, video));

        editorWrapper.addEventListener("click", event => playPauseMedia(event, video, editorWrapper));

        video.addEventListener("playing", event => updatePlayState());
        video.addEventListener("pause", event => updatePlayState());
      }

      renderMedia().then(mediaData => {
        if (!mediaData) return;

        const { transcript, id: itemId, video } = mediaData;
        const { track, cues } = addTrack(video, transcript);
        const form = addTranscript({ track, cues, itemId, editorWrapper });

        track.addEventListener("cuechange", event => highlightCueSegment(event, video));
        editorWrapper.addEventListener("click", event => playPauseMedia(event, video, editorWrapper));
        video.addEventListener("playing", event => updatePlayState(event, video, editorWrapper));
        video.addEventListener("pause", event => updatePlayState(event, video, editorWrapper));
        form.addEventListener("submit", event => event.preventDefault());
        form.addEventListener("change", event => {
          const data = new FormData(form);
          console.log(data);
        });
      });
    </script>
  </body>
</html>
