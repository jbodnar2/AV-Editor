<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="./favicon.ico" />
    <link rel="stylesheet" href="css/reset.css" />
    <link rel="stylesheet" href="css/main.css" />
    <title>AV Editor</title>
  </head>

  <body>
    <header>
      <div class="container">
        <h1>Editor</h1>
      </div>
    </header>
    <nav>
      <div class="container">
        <ul>
          <li><a href="./">Home</a></li>
        </ul>
      </div>
    </nav>
    <main>
      <div class="container editor">
        <!-- Main content start -->

        <h2 id="page-title">Video Title</h2>

        <div id="media-wrapper" class="media-wrapper">
          <!-- Media & Global Controls Content -->
        </div>

        <div id="editor-wrapper" class="editor-wrapper" data-show-end>
          <!-- Editor Content -->
        </div>

        <!-- Main content end -->
      </div>
    </main>

    <footer></footer>
    <!-- Scripts -->
    <script type="module" defer>
      import { getMediaItem } from "./js/components/api.js";
      import { addTrack } from "./js/components/tracks.js";
      import { addTranscript } from "./js/components/transcripts.js";

      const pageTitle = document.querySelector("#page-title");
      const mediaWrapper = document.querySelector("#media-wrapper");
      const editorWrapper = document.querySelector("#editor-wrapper");

      function showNoMediaMessage() {
        document.querySelector("main").innerHTML =
          '<div class="info info--warning">Sorry. The item you\'re looking for isn\'t available. You can <a href="/">browse our library</a> for a different item.</div>';
      }

      async function renderMedia() {
        const mediaItem = await getMediaItem();

        if (!mediaItem) {
          showNoMediaMessage();
          return;
        }

        const { id, title, url, poster, transcript } = mediaItem;
        const video = document.createElement("video");
        Object.assign(video, {
          controls: true,
          poster,
          src: url,
          id: `video-${id}`,
        });

        Object.assign(pageTitle, { textContent: title });
        document.title = `${title} | ${document.title}`;

        mediaWrapper.textContent = "";
        mediaWrapper.appendChild(video);

        return { transcript, id, video };
      }

      function highlightCueSegment(event, video) {
        const activeCue = event.target.activeCues?.[0];
        if (!activeCue) return;

        const scrollTargetID = `cue-${activeCue.id}`;
        const scrollTarget = editorWrapper.querySelector(`#${scrollTargetID}`);
        const timeButton = scrollTarget?.querySelector(".cue-select-button");

        const isPlaying = video.paused;

        const previousCues = [...editorWrapper.querySelectorAll(".cue--focus")];
        previousCues.forEach(previousCue => {
          previousCue.classList.remove("cue--focus");
          previousCue.querySelector(".cue-select-button")?.classList.toggle("cue-select-button--playing", false);
        });

        scrollTarget?.classList.add("cue--focus");
        timeButton?.classList.toggle("cue-select-button--playing", isPlaying);

        scrollTarget?.scrollIntoView({ behavior: "smooth", block: "center" });
      }

      function setToTime(event, video) {
        const target = event.target.closest(".cue");
        if (!target) return;

        const cueTime = target.dataset.startTime;
        if (!cueTime) return;

        video.currentTime = parseFloat(cueTime);
      }

      function playPauseMedia(event, video, editorWrapper) {
        setToTime(event, video);
        const isPlaying = video.paused;
        editorWrapper.classList.toggle("is-playing", !isPlaying);

        if (!event.target.matches(".cue-play-button, .cue-pause-button")) return;

        isPlaying ? video.play() : video.pause();
      }

      function updatePlayState(event, video, editorWrapper) {
        const isPlaying = !video.paused;
        editorWrapper.classList.toggle("is-playing", isPlaying);
      }

      document.addEventListener("DOMContentLoaded", () => {
        renderMedia().then(mediaData => {
          if (!mediaData) return;

          const { transcript, id: itemId, video } = mediaData;
          const { track, cues } = addTrack(video, transcript);
          const form = addTranscript({ track, cues, itemId, editorWrapper });

          const eventHandlers = {
            cuechange: highlightCueSegment,
            playing: updatePlayState,
            pause: updatePlayState,
          };

          for (const [type, handler] of Object.entries(eventHandlers)) {
            track.addEventListener(type, event => handler(event, video));
          }

          const delegatedHandlers = {
            click: event => playPauseMedia(event, video, editorWrapper),
          };

          for (const [type, handler] of Object.entries(delegatedHandlers)) {
            editorWrapper.addEventListener(type, handler);
          }

          ["playing", "pause"].forEach(type => {
            video.addEventListener(type, event => updatePlayState(event, video, editorWrapper));
          });

          // TODO: Figure out how to submit, update changes to localstorage
          form.addEventListener("submit", event => event.preventDefault());
          form.addEventListener("change", event => {
            const data = new FormData(form);
            console.log(data);
          });
        });
      });
    </script>
  </body>
</html>
