<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="css/reset.css" />
    <link rel="stylesheet" href="css/main.css" />
    <title>AV Editor</title>
  </head>

  <body>
    <header>
      <div class="container">
        <h1>Editor</h1>
      </div>
    </header>
    <nav>
      <div class="container">
        <ul>
          <li><a href="/">Home</a></li>
        </ul>
      </div>
    </nav>
    <main>
      <div class="container">
        <!-- Main content start -->

        <div id="media-wrapper"></div>
        <div id="editor-wrapper"></div>

        <!-- Main content end -->
      </div>
    </main>

    <footer></footer>
    <!-- Scripts -->
    <script type="module" defer>
      import { getMediaItem } from "./js/components/api.js";

      const mediaWrapper = document.querySelector("#media-wrapper");
      const editorWrapper = document.querySelector("#editor-wrapper");

      // Get the media data and render video
      async function renderMedia() {
        const mediaItem = await getMediaItem();

        if (!mediaItem) {
          mediaWrapper.innerHTML = showNoMediaMessage();
          return;
        }

        const { id, title, url, poster, transcript } = mediaItem;
        const video = document.createElement("video");
        video.controls = true;
        video.poster = poster;
        video.src = url;
        video.id = `video-${id}`;

        const h2 = document.createElement("h2");
        h2.textContent = title;

        mediaWrapper.textContent = "";
        mediaWrapper.appendChild(h2);
        mediaWrapper.appendChild(video);

        return { transcript, id, video };
      }

      // Returns no media message if media item is not found
      function showNoMediaMessage() {
        return '<div class="info info--warning">Sorry. The item you\'re looking for isn\'t available. You can <a href="/">browse our library</a> for a different item.</div>';
      }

      // Helper to convert track cue seconds to HH:MM:SS format
      function getFormattedTimeFromSeconds(seconds) {
        const hours = (Math.floor(seconds / 3600) % 24).toString().padStart(2, "0");
        const minutes = Math.floor((seconds % 3600) / 60)
          .toString()
          .padStart(2, "0");
        seconds = Math.floor(seconds % 60)
          .toString()
          .padStart(2, "0");
        return `${hours}:${minutes}:${seconds}`;
      }

      function getWordProbabilities(words) {
        const probabilities = words.map(word => word.probability);
        const avg =
          Math.round((probabilities.reduce((acc, prob) => acc + prob, 0) / probabilities.length) * 1000) / 1000;
        const min = Math.round(Math.min(...probabilities) * 1000) / 1000;
        const max = Math.round(Math.max(...probabilities) * 1000) / 1000;

        return { avg, min, max };
      }

      // Add transcript track and cues to video
      function addTrack(video, transcript, itemId) {
        const track = video.addTextTrack("captions", transcript.label, transcript.language);
        track.mode = "showing";

        transcript.segments.forEach(segment => {
          const { id, start, end, text, words } = segment;

          const cue = new VTTCue(start, end, text);
          cue.id = id;
          cue.formattedTime = getFormattedTimeFromSeconds(start);
          const { avg, min, max } = getWordProbabilities(words);
          cue.avgProb = avg;
          cue.maxProb = max;
          cue.minProb = min;
          track.addCue(cue);
          console.log(cue);
        });
      }

      // Render media then add track from transcript
      renderMedia().then(data => {
        if (!data) return;
        const { transcript, id: itemId, video } = data;

        addTrack(video, transcript, itemId);
      });
    </script>
  </body>
</html>
