<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="css/_reset.css" />
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="css/style.css" />
    <title>AV Editor</title>
  </head>

  <body>
    <header>
      <div class="container">
        <h1>Editor</h1>
      </div>
    </header>
    <nav>
      <div class="container">
        <ul>
          <li><a href="/">Home</a></li>
        </ul>
      </div>
    </nav>
    <main>
      <div class="container editor">
        <!-- Main content start -->
        <h2 id="page-title">Video Title</h2>

        <div id="media-wrapper" class="media-wrapper">
          <!-- Media & Global Controls Content -->
        </div>

        <div id="editor-wrapper" class="editor-wrapper">
          <!-- Transcript & Editor Content Start -->

          <div
            id="cue-${id}"
            data-cue="${id}"
            data-start-time="${startTime}"
            data-end-time="${endTime}"
            data-average-probability=""
            data-min-probability=""
            data-max-probability=""
            data-median-probability=""
            class="cue"
          >
            <div class="cue-controls">
              <button class="cue-select-button">HH:MM:SS</button>

              <button class="cue-play-button" aria-label="Play and Pause"></button>
            </div>
            <form action="javascript:void(0);" method="" class="cue-form">
              <input type="text" class="cue-input" value="This is a line of text in the editor" />
            </form>
          </div>

          <!-- Transcript & Editor Content End-->
        </div>
        <!-- Main content end -->
      </div>
    </main>

    <footer></footer>
    <!-- Scripts -->
    <script type="module" defer>
      import { getMediaItem } from "./js/components/api.js";

      const pageTitle = document.querySelector("#page-title");
      const mediaWrapper = document.querySelector("#media-wrapper");
      const editorWrapper = document.querySelector("#editor-wrapper");

      // Get the media data and render video
      async function renderMedia() {
        const mediaItem = await getMediaItem();

        if (!mediaItem) {
          mediaWrapper.innerHTML = showNoMediaMessage();
          return;
        }

        const { id, title, url, poster, transcript } = mediaItem;
        const video = document.createElement("video");
        video.controls = true;
        video.poster = poster;
        video.src = url;
        video.id = `video-${id}`;

        pageTitle.textContent = title;
        document.title = `${title} | ${document.title}`;

        mediaWrapper.textContent = "";

        mediaWrapper.appendChild(video);

        return { transcript, id, video };
      }

      // Returns no media message if media item is not found
      function showNoMediaMessage() {
        return '<div class="info info--warning">Sorry. The item you\'re looking for isn\'t available. You can <a href="/">browse our library</a> for a different item.</div>';
      }

      // Helper to convert track cue seconds to HH:MM:SS format
      function getFormattedTimeFromSeconds(seconds) {
        const hours = (Math.floor(seconds / 3600) % 24).toString().padStart(2, "0");
        const minutes = Math.floor((seconds % 3600) / 60)
          .toString()
          .padStart(2, "0");
        seconds = Math.floor(seconds % 60)
          .toString()
          .padStart(2, "0");
        return `${hours}:${minutes}:${seconds}`;
      }

      // Helper to get avg, min, max from array of nums between 0 and 1
      function getWordProbabilities(words) {
        if (!words) return;

        const probabilities = words.map(word => word.probability);
        const avg =
          Math.round((probabilities.reduce((acc, prob) => acc + prob, 0) / probabilities.length) * 1000) / 1000;
        const min = Math.round(Math.min(...probabilities) * 1000) / 1000;
        const max = Math.round(Math.max(...probabilities) * 1000) / 1000;

        return { avg, min, max };
      }

      // Add track and cues to video from transcript segments
      function addTrack(video, transcript) {
        const track = video.addTextTrack("captions", transcript.label, transcript.language);
        track.mode = "showing";
        // Flag to check if track has been edited, and saved to local storage
        // If edited, probs calculated already and won't have words, etc
        track.edited = false;

        let cues = transcript.segments.map(segment => {
          const { id, start, end, text, words } = segment;

          const cue = new VTTCue(start, end, text);
          cue.id = id;
          cue.formattedTime = getFormattedTimeFromSeconds(start);

          // Only compute probs if word-level time stamps are available
          // Perhaps update session store function to modify on initial store to
          // avoid recalcuation on each refresh. Replace "words" with "probabilities"?
          if (words) {
            const { avg, min, max } = getWordProbabilities(words, track.edited);
            cue.avgProb = avg;
            cue.maxProb = max;
            cue.minProb = min;
          }

          track.addCue(cue);

          return cue;
        });

        return { track, cues };
      }

      function addTranscript({ track, cues }) {
        // ...
      }

      // Render media then add track from transcript
      renderMedia().then(mediaData => {
        if (!mediaData) return;
        const { transcript, id: itemId, video } = mediaData;

        // Add track and cues to video from transcript segments
        const { track, cues } = addTrack(video, transcript);

        // Generate, render transcript editor code
        addTranscript({ track, cues });
      });
    </script>
  </body>
</html>
